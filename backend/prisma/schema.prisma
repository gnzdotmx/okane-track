// Prisma Schema for OkaneTrack

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  firstName     String
  lastName      String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  accounts      Account[]
  transactions  Transaction[]
  budgets       Budget[]
  
  @@map("users")
}

// Currency model
model Currency {
  id            String         @id @default(uuid())
  code          String         @unique // USD, JPY, EUR, etc.
  name          String         // US Dollar, Japanese Yen, etc.
  symbol        String         // $, ¥, €, etc.
  exchangeRate  Float          @default(1.0) // Rate relative to base currency
  isBase        Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  accounts      Account[]
  transactions  Transaction[]
  
  @@map("currencies")
}

// Account/Card model - supports multiple cards in different currencies
model Account {
  id            String         @id @default(uuid())
  userId        String
  name          String         // "Main JPY Account", "USD Savings", etc.
  type          AccountType
  currencyId    String
  balance       Float          @default(0)
  initialBalance Float         @default(0) // Store initial balance separately
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  currency      Currency       @relation(fields: [currencyId], references: [id])
  transactions  Transaction[]
  
  @@map("accounts")
  @@index([userId])
  @@index([currencyId])
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  CASH
  INVESTMENT
}

// Budget Categories following your system
model BudgetCategory {
  id            String         @id @default(uuid())
  name          String         @unique // Expenses, Savings, Investment, Emergencies
  percentage    Float          // 40, 20, 20, 20
  description   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  budgets       Budget[]
  transactions  Transaction[]
  
  @@map("budget_categories")
}

// Budget tracking per user per category
model Budget {
  id              String         @id @default(uuid())
  userId          String
  categoryId      String
  startingBalance Float
  allocatedAmount Float          // Amount allocated per period
  currentBalance  Float
  year            Int
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category        BudgetCategory @relation(fields: [categoryId], references: [id])
  
  @@unique([userId, categoryId, year])
  @@map("budgets")
  @@index([userId])
  @@index([categoryId])
}

// Transaction Types
model TransactionType {
  id            String         @id @default(uuid())
  name          String         @unique // EXPENSE, INCOME, TRANSFER, REIMBURSEMENT
  description   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  transactions  Transaction[]
  
  @@map("transaction_types")
}

// Expense Types (Transporte, Comida, etc.)
model ExpenseType {
  id            String         @id @default(uuid())
  name          String         @unique // Transporte, Comida, Internet, Salud, etc.
  icon          String?
  color         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  transactions  Transaction[]
  
  @@map("expense_types")
}

// Main Transaction model
model Transaction {
  id                  String         @id @default(uuid())
  userId              String
  accountId           String
  date                DateTime
  amount              Float
  currencyId          String
  description         String?
  expenseTypeId       String?
  transactionTypeId   String
  budgetCategoryId    String
  isReimbursable      Boolean        @default(false)
  reimbursementId     String?        @unique
  linkedTransactionId String?        @unique // For linking reimbursements to original expenses
  notes               String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  // Relations
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  account             Account        @relation(fields: [accountId], references: [id])
  currency            Currency       @relation(fields: [currencyId], references: [id])
  expenseType         ExpenseType?   @relation(fields: [expenseTypeId], references: [id])
  transactionType     TransactionType @relation(fields: [transactionTypeId], references: [id])
  budgetCategory      BudgetCategory @relation(fields: [budgetCategoryId], references: [id])
  linkedTransaction   Transaction?   @relation("ReimbursementLink", fields: [linkedTransactionId], references: [id])
  reimbursement       Transaction?   @relation("ReimbursementLink")
  
  @@map("transactions")
  @@index([userId])
  @@index([accountId])
  @@index([date])
  @@index([transactionTypeId])
  @@index([budgetCategoryId])
  @@index([currencyId])
}

// Import History for tracking CSV imports
model ImportHistory {
  id            String         @id @default(uuid())
  userId        String
  fileName      String
  recordCount   Int
  successCount  Int
  errorCount    Int
  errors        String?        // JSON string of errors
  importedAt    DateTime       @default(now())
  
  @@map("import_history")
  @@index([userId])
}

